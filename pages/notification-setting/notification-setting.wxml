<!-- 通知设置页面 -->
<view class="container">
  <view wx:if="{{isLoading}}" class="loading-container">
    <loading type="spinner" text="加载中..."></loading>
  </view>
  <block wx:else>
    <!-- 通知总开关 -->
    <view class="section main-switch-section">
      <view class="main-switch">
        <view class="switch-label">
          <view class="switch-title">接收通知</view>
          <view class="switch-desc">开启后可接收应用内通知及订阅消息</view>
        </view>
        <switch 
          class="wx-switch"
          checked="{{notificationMainSwitch}}"
          bindchange="toggleMainSwitch"
          color="#D84315"
        />
      </view>
    </view>
    
    <!-- 微信订阅消息 -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">微信订阅消息</text>
        <text class="section-desc">开启后，即使不打开小程序也能收到微信通知</text>
      </view>
      
      <view class="section-content">
        <view 
          class="subscription-item {{!notificationMainSwitch ? 'disabled' : ''}}"
          wx:for="{{subscriptionSettings}}"
          wx:key="id"
          bindtap="requestSubscription"
          data-index="{{index}}"
        >
          <view class="item-info">
            <view class="item-name">{{item.name}}</view>
            <view class="item-desc">{{item.desc}}</view>
          </view>
          <view class="item-status {{item.status ? 'subscribed' : ''}}">
            <text>{{item.status ? '已订阅' : '未订阅'}}</text>
          </view>
        </view>
        
        <view class="subscription-tips">
          <text class="tips-icon">i</text>
          <text class="tips-text">微信订阅消息需要您手动确认，且订阅时效为7天</text>
        </view>
      </view>
    </view>
    
    <!-- 应用内通知设置 -->
    <view class="section {{!notificationMainSwitch ? 'disabled-section' : ''}}">
      <view class="section-header">
        <text class="section-title">应用内通知设置</text>
        <text class="section-desc">控制在应用内接收通知的方式</text>
      </view>
      
      <view class="section-content">
        <!-- 声音提醒 -->
        <view class="setting-item">
          <view class="item-left">
            <text class="item-name">声音提醒</text>
          </view>
          <view class="item-right">
            <switch 
              class="mini-switch" 
              checked="{{appNotificationSettings.sound}}" 
              color="#D84315" 
              bindchange="toggleAppNotification"
              data-type="sound"
              disabled="{{!notificationMainSwitch}}"
            />
          </view>
        </view>
        
        <!-- 震动提醒 -->
        <view class="setting-item">
          <view class="item-left">
            <text class="item-name">震动提醒</text>
          </view>
          <view class="item-right">
            <switch 
              class="mini-switch" 
              checked="{{appNotificationSettings.vibrate}}" 
              color="#D84315" 
              bindchange="toggleAppNotification"
              data-type="vibrate"
              disabled="{{!notificationMainSwitch}}"
            />
          </view>
        </view>
        
        <!-- 消息角标 -->
        <view class="setting-item">
          <view class="item-left">
            <text class="item-name">消息角标</text>
          </view>
          <view class="item-right">
            <switch 
              class="mini-switch" 
              checked="{{appNotificationSettings.badge}}" 
              color="#D84315" 
              bindchange="toggleAppNotification"
              data-type="badge"
              disabled="{{!notificationMainSwitch}}"
            />
          </view>
        </view>
        
        <!-- 夜间免打扰 -->
        <view class="setting-item">
          <view class="item-left">
            <text class="item-name">夜间免打扰</text>
            <text class="item-desc">22:00 - 08:00 期间静音</text>
          </view>
          <view class="item-right">
            <switch 
              class="mini-switch" 
              checked="{{appNotificationSettings.nightMode}}" 
              color="#D84315" 
              bindchange="toggleAppNotification"
              data-type="nightMode"
              disabled="{{!notificationMainSwitch}}"
            />
          </view>
        </view>
      </view>
    </view>

    <!-- 通知历史记录 -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">通知历史记录</text>
        <text class="section-desc">查看已接收的所有通知消息</text>
      </view>
      
      <view class="section-content">
        <view wx:if="{{notificationHistory.length > 0}}">
          <view class="history-item" wx:for="{{notificationHistory}}" wx:key="id" bindtap="viewNotificationDetail" data-id="{{item.id}}">
            <view class="history-item-header">
              <text class="history-item-title">{{item.title}}</text>
              <text class="history-item-time">{{item.time}}</text>
            </view>
            <view class="history-item-content">{{item.content}}</view>
            <view class="history-item-footer">
              <text class="history-item-tag">{{item.type}}</text>
              <text class="history-item-status {{item.read ? 'read' : 'unread'}}">{{item.read ? '已读' : '未读'}}</text>
            </view>
          </view>
        </view>
        <view wx:else class="empty-history">
          <view class="empty-icon">📪</view>
          <view class="empty-text">暂无通知记录</view>
        </view>
        
        <view class="history-footer">
          <view class="history-btn" bindtap="viewAllNotifications">查看全部通知</view>
          <view class="history-btn clear" bindtap="clearAllNotifications">清空通知</view>
        </view>
      </view>
    </view>
    
    <!-- 通知权限管理 -->
    <view class="manage-container">
      <view class="manage-btn" bindtap="openSettingPage">
        <text>管理系统通知权限</text>
      </view>
      <view class="manage-tips">
        若无法接收推送，请确认在微信中已授权或在系统设置中允许通知
      </view>
    </view>
  </block>
</view> 