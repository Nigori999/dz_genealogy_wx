<!-- 个人中心页面 -->
<view class="container">
  <!-- 用户信息 -->
  <view class="user-info">
    <view class="user-avatar" bindtap="uploadAvatar">
      <image 
        src="{{userInfo.avatar || '/assets/images/avatar_default.png'}}" 
        mode="aspectFill"
      ></image>
      <view class="avatar-edit-hint">点击更换</view>
    </view>
    <view class="user-name">{{userInfo.nickname || '未登录'}}</view>
    <view class="user-status">
      <text wx:if="{{currentGenealogy}}">当前族谱：{{currentGenealogy.name}}</text>
      <text wx:else>暂无族谱</text>
    </view>
  </view>

  <!-- 我的族谱 -->
  <view class="section">
    <view class="section-header">
      <view class="section-title">我的族谱</view>
      <view wx:if="{{genealogies.length > 0}}" class="section-action" bindtap="navigateToSwitchGenealogy">
        <text>管理</text>
        <text class="iconfont icon-arrow-right"></text>
      </view>
    </view>
    <view class="genealogy-list">
      <view wx:if="{{isLoading}}" class="list-loading">
        <loading type="spinner" text="加载中..."></loading>
      </view>
      <block wx:elif="{{genealogies.length > 0}}">
        <family-card 
          wx:for="{{genealogies}}" 
          wx:key="id"
          genealogy="{{item}}"
          bind:select="onGenealogySelect"
        ></family-card>
        <!-- 族谱数量到达上限时显示提示 -->
        <view wx:if="{{hasReachedGenealogyLimit}}" class="limit-tip">
          <text>您已创建 {{genealogies.length}} 个族谱，已达到当前订阅的最大限制</text>
          <view class="tip-action" bindtap="navigateToSubscription">升级订阅</view>
        </view>
        <!-- 未达到上限时显示创建按钮 -->
        <view wx:else class="add-genealogy" bindtap="navigateToCreateGenealogy">
          <text class="iconfont icon-add"></text>
          <text>创建新族谱</text>
        </view>
      </block>
      <view wx:else class="empty-genealogy">
        <image class="empty-image" src="/assets/images/empty_genealogy.png" mode="aspectFit"></image>
        <view class="empty-text">您还没有创建或加入任何族谱</view>
        <view class="empty-actions">
          <button class="btn-primary" bindtap="navigateToCreateGenealogy">创建族谱</button>
          <button class="btn-secondary" bindtap="navigateToJoinGenealogy">加入族谱</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 功能菜单 -->
  <view class="menu-section">
    <!-- 订阅信息 -->
    <view class="menu-card subscription-card" bindtap="navigateToSubscription">
      <view class="subscription-info">
        <view class="subscription-title">当前订阅：{{subscriptionPlan.name}}</view>
        <view class="subscription-detail">
          <text>族谱：{{subscriptionPlan.genealogyLimit || 0}} / 席位：{{subscriptionPlan.memberLimit || 0}} / 存储：{{formatStorage(subscriptionPlan.storageLimit)}}</text>
        </view>
      </view>
      <view class="subscription-action">
        <text>查看详情</text>
        <text class="iconfont icon-arrow-right"></text>
      </view>
    </view>

    <!-- 菜单列表 -->
    <view class="menu-list">
      <!-- 族谱管理 -->
      <view class="menu-group">
        <view class="menu-group-title">族谱管理</view>
        <view class="menu-item" bindtap="navigateToFamilyManager">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-family"></text>
            <text class="menu-name">族谱席位管理</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
        <view class="menu-item" bindtap="navigateToInviteManager">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-invite"></text>
            <text class="menu-name">邀请管理</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
        <view class="menu-item" bindtap="navigateToDataExport">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-export"></text>
            <text class="menu-name">数据导出</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>

      <!-- 账户设置 -->
      <view class="menu-group">
        <view class="menu-group-title">账户设置</view>
        <view class="menu-item" bindtap="navigateToAccountSetting">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-setting"></text>
            <text class="menu-name">账户与安全</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
        <!-- 通知设置菜单项 -->
        <view class="menu-item" bindtap="navigateToNotificationSetting">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-notification"></text>
            <text class="menu-name">通知设置</text>
            <!-- 未读通知数量 -->
            <view wx:if="{{unreadCount > 0}}" class="unread-badge">{{unreadCount > 99 ? '99+' : unreadCount}}</view>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>

      <!-- 关于 -->
      <view class="menu-group">
        <view class="menu-group-title">关于</view>
        <view class="menu-item" bindtap="navigateToHelp">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-help"></text>
            <text class="menu-name">帮助中心</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
        <view class="menu-item" bindtap="navigateToAbout">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-about"></text>
            <text class="menu-name">关于我们</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
        <view class="menu-item" bindtap="navigateToFeedback">
          <view class="menu-item-left">
            <text class="menu-icon iconfont icon-feedback"></text>
            <text class="menu-name">意见反馈</text>
          </view>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
    </view>

    <!-- 退出登录 -->
    <view class="logout-btn" bindtap="logout">退出登录</view>
  </view>

  <!-- 版本信息 -->
  <view class="version-info">
    <text>云族谱 v1.0.0</text>
  </view>
</view>